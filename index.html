<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Ù„Ø¹Ø¨Ø© Ù…ØªØ§Ù‡Ø© - 3 Ù…Ø±Ø§Ø­Ù„ Ù…Ø¹ Ø£Ø³Ø¦Ù„Ø©</title>
  <style>
    :root{--bg:#071129;--card:#0b1a2a;--accent:#06b6d4;--danger:#ef4444;--muted:#94a3b8}
    *{box-sizing:border-box;font-family:Inter,system-ui,Arial,sans-serif}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#031225,#07182a);color:#e6eef6}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
    .game{width:980px;max-width:99%;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border-radius:14px;padding:8px 4px;border:1px solid rgba(255,255,255,0.03)}
    header{display:flex;justify-content:space-between;align-items:center}
    h1{margin:0;font-size:20px}
    .info{display:flex;gap:12px;align-items:center}
    .hearts{display:flex;gap:6px}
    .heart{width:22px;height:22px;border-radius:4px;background:var(--accent);display:inline-block}
    .heart.lost{background:rgba(255,255,255,0.06);opacity:0.36}
    .stage{font-size:14px;color:var(--muted)}

    .board-and-controls{display:flex;gap:12px;margin-top:8px;}
    .board{width:100%;max-width:700px;background:#071b2b;border-radius:10px;padding:8px;display:flex;flex-direction:column;align-items:center;}
    .grid{width:100%;max-width:640px;aspect-ratio:4/3;display:grid;grid-template-columns:repeat(16,1fr);grid-template-rows:repeat(12,1fr);gap:2px;background:#041424;padding:6px;border-radius:8px}
    .cell{width:100%;height:100%;background:#072233;border-radius:3px}
    .cell.wall{background:#0f1720}
    .cell.exit{background:linear-gradient(180deg,#06b6d4,#8b5cf6)}
    .player{background:#ffd166;display:flex;align-items:center;justify-content:center;font-weight:700}

    .control-area{display:flex;flex-direction:column;align-items:center;width:100%;margin-top:12px;}
    .control-buttons{
        display:none;
        flex-direction:column;
        gap:12px;
        align-items:center;
        margin:0 auto;
        width:100%;
        max-width:340px;
    }
    .ctrl-row{display:flex;gap:12px;justify-content:center;}
    .ctrl-btn{
        width:68px;
        height:68px;
        border-radius:16px;
        background:var(--accent);
        border:none;
        font-size:30px;
        font-weight:700;
        color:#072133;
        touch-action:manipulation;
        box-shadow:0 2px 12px 0 rgba(6,182,212,0.09);
        transition:background .15s;
    }
    .ctrl-btn:active{background:var(--danger);color:#fff}
    .ctrl-btn:focus{outline:3px solid var(--accent);background:#3edbf8}

    .sidebar{flex:1;min-width:240px}
    .panel{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px}
    button{background:var(--accent);border:none;padding:10px 12px;border-radius:8px;color:#072133;font-weight:700;cursor:pointer;font-size:17px;}
    .ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}

    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:60}
    .overlay .card{background:#061322;padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);width:min(720px,95%)}
    .q-options{display:flex;flex-direction:column;gap:8px;margin-top:12px}
    .q-btn{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;text-align:right;cursor:pointer}
    .q-btn.correct{outline:3px solid rgba(6,182,212,0.14)}

    .footer{margin-top:12px;color:var(--muted);font-size:13px}

    @media (max-width:900px){
      .game{width:100vw;}
      .board-and-controls{flex-direction:column}
      .board{max-width:100vw;}
      .sidebar{min-width:0;}
      .control-area{margin-top:6px;}
      .grid{height:54vw;max-width:100vw;min-height:220px;}
    }
    @media (max-width:600px){
      .wrap,body,html{padding:0}
      .game{padding:1px;}
      .board{padding:2px;}
      .grid{height:57vw;min-height:130px;}
      .control-buttons{display:flex;}
      .ctrl-btn{width:50px;height:50px;font-size:23px;}
      .panel{padding:9px;}
      button{font-size:15px;}
    }

    @media (max-width:440px){
      h1{font-size:17px;}
      .ctrl-btn{width:36px;height:36px;font-size:16px;}
      .panel{padding:7px;}
      button{font-size:13px;}
    }

  </style>
</head>
<body>
  <div class="wrap">
    <div class="game" role="application">
      <header>
        <h1>Ù„Ø¹Ø¨Ø© Ø§Ù„Ù…ØªØ§Ù‡Ø© â€” 3 Ù…Ø±Ø§Ø­Ù„ Ù…Ø¹ Ø£Ø³Ø¦Ù„Ø©</h1>
        <div class="info">
          <div class="stage">Ø§Ù„Ù…Ø±Ø­Ù„Ø©: <span id="stageNum">1</span>/3</div>
          <div class="hearts" id="hearts"></div>
        </div>
      </header>

      <div class="board-and-controls">
        <div class="board panel">
          <div class="grid" id="grid" tabindex="0" aria-label="Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ§Ù‡Ø©"></div>
          <div class="control-area">
            <div class="control-buttons" id="controlsMobile">
              <div class="ctrl-row">
                <button class="ctrl-btn" id="ctrlUp" title="Ø£Ø¹Ù„Ù‰">â¬†</button>
              </div>
              <div class="ctrl-row">
                <button class="ctrl-btn" id="ctrlLeft" title="ÙŠØ³Ø§Ø±">â¡</button>
                <button class="ctrl-btn" id="ctrlDown" title="Ø£Ø³ÙÙ„">â¬‡</button>
                <button class="ctrl-btn" id="ctrlRight" title="ÙŠÙ…ÙŠÙ†">â¬…</button>
              </div>
            </div>
            <div style="margin-top:8px;color:var(--muted);font-size:13px">Ø§Ø³ØªØ®Ø¯Ù… Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø£Ø³Ù‡Ù… Ø£Ùˆ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ø¯Ù†Ø§Ù‡ Ù„Ù„Ø­Ø±ÙƒØ©. Ø§Ù„Ù‡Ø¯Ù: Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø¨Ø§Ø¨ Ø§Ù„Ø®Ø±ÙˆØ¬.</div>
          </div>
        </div>

        <aside class="sidebar">
          <div class="panel">
            <div><strong>Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù„Ø¹Ø¨Ø©</strong></div>
            <ul style="margin:8px 0 0 0;padding-left:18px;color:var(--muted)">
              <li>Ù‡Ù†Ø§Ùƒ 3 Ù…Ø±Ø§Ø­Ù„ Ù…ØªØ§Ù‡Ø© Ù…ØªØ²Ø§ÙŠØ¯Ø© Ø§Ù„ØµØ¹ÙˆØ¨Ø©.</li>
              <li>Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† ÙƒÙ„ Ù…Ø±Ø­Ù„Ø© ÙŠØ¸Ù‡Ø± Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¸Ø§Ù… Ø®ÙŠØ§Ø±Ø§Øª.</li>
              <li>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© ØªÙ†ØªÙ‚Ù„ Ù„Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©.</li>
              <li>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø®Ø§Ø·Ø¦Ø© ØªØ¹ÙŠØ¯Ùƒ Ù„Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ÙˆØªÙÙ‚Ø¯ Ù‚Ù„Ø¨Ø§Ù‹.</li>
              <li>Ù„Ø¯ÙŠÙƒ 4 Ù‚Ù„ÙˆØ¨ â€” Ø¥Ù† ÙÙÙ‚Ø¯Øª Ø¬Ù…ÙŠØ¹Ù‡Ø§ ØªØ®Ø³Ø± Ø§Ù„Ù„Ø¹Ø¨Ø©.</li>
            </ul>
            <div style="margin-top:12px;display:flex;gap:8px">
              <button id="restart">Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ø¯Ø¡</button>
              <button class="ghost" id="hint">Ø¥Ø¸Ù‡Ø§Ø± ØªÙ„Ù…ÙŠØ­</button>
            </div>
            <div style="margin-top:12px;color:var(--muted)">Ø§Ù„Ø­Ø§Ù„Ø©: <span id="status">Ø¬Ø§Ù‡Ø²</span></div>
          </div>
          <div class="panel" style="margin-top:12px">
            <div style="font-weight:700">Ø§Ù„Ø¥Ø­ØµØ§Ø¡Ø§Øª</div>
            <div style="margin-top:8px;color:var(--muted)">Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <span id="statStage">1</span></div>
            <div style="margin-top:6px;color:var(--muted)">Ù‚ÙÙ„ÙˆØ¨ Ù…ØªØ¨Ù‚ÙŠØ©: <span id="statHearts">4</span></div>
            <div style="margin-top:6px;color:var(--muted)">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª: <span id="attempts">0</span></div>
          </div>
        </aside>
      </div>
      <div class="footer"> .</div>
    </div>
  </div>

  <!-- Ø³Ø¤Ø§Ù„ overlay -->
  <div class="overlay" id="questionOverlay" aria-hidden="true">
    <div class="card">
      <h2 id="qTitle">Ø³Ø¤Ø§Ù„</h2>
      <div id="qText" style="margin-top:8px;color:var(--muted)"></div>
      <div class="q-options" id="qOptions"></div>
      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
        <button id="closeQ" class="ghost">Ø¥ØºÙ„Ø§Ù‚ Ù…Ø¤Ù‚Øª</button>
      </div>
    </div>
  </div>
  <!-- Game over overlay -->
  <div class="overlay" id="gameOverOverlay" aria-hidden="true">
    <div class="card" style="text-align:center">
      <h2 style="margin:0">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>
      <p id="gameOverMsg" style="color:var(--muted)">Ø®Ø³Ø±Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ù„ÙˆØ¨.</p>
      <div style="margin-top:12px"><button id="tryAgain">Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯</button></div>
    </div>
  </div>
  <script>
    // Game configuration
    const gridCols = 16, gridRows = 12; // 16x12 cells
    const totalStages = 3;
    let stage = 1;
    let hearts = 4;
    let attempts = 0;

    // Define three simple maze maps (0=free,1=wall,2=player start,3=exit)
    // Each map is an array of gridRows * gridCols numbers in row-major order
    const maps = [
      [
        1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
        1,2,0,0,0,0,0,1,0,0,0,0,0,3,0,1,
        1,0,1,1,0,1,0,1,0,1,1,1,0,1,0,1,
        1,0,1,0,0,1,0,0,0,1,0,0,0,1,0,1,
        1,0,1,0,1,1,1,1,0,1,0,1,0,1,0,1,
        1,0,0,0,0,0,0,1,0,1,0,1,0,0,0,1,
        1,1,1,1,1,1,0,1,0,1,0,1,1,1,0,1,
        1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,1,
        1,0,1,1,0,1,1,1,0,1,1,1,0,1,0,1,
        1,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,
        1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,1,
        1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
      ],
      [
        1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
        1,2,0,1,0,0,0,1,0,0,1,0,0,0,3,1,
        1,0,0,1,0,1,0,1,1,0,1,0,1,0,0,1,
        1,0,1,1,0,1,0,0,1,0,0,0,1,1,0,1,
        1,0,1,0,0,1,1,0,1,1,1,0,0,1,0,1,
        1,0,1,0,1,1,0,0,0,0,1,0,1,1,0,1,
        1,0,0,0,0,0,0,1,1,0,1,0,0,0,0,1,
        1,1,1,1,1,1,0,1,0,0,1,1,1,1,0,1,
        1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,1,
        1,0,1,1,0,1,1,1,0,1,1,1,0,1,0,1,
        1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,
        1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
      ],
      [
        1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
        1,2,0,1,0,0,0,1,0,1,0,0,0,1,3,1,
        1,0,1,1,0,1,0,1,0,1,1,1,0,1,0,1,
        1,0,1,0,0,1,0,0,0,1,0,0,0,1,0,1,
        1,0,1,0,1,1,1,1,0,1,0,1,0,1,0,1,
        1,0,0,0,0,0,1,1,0,1,0,1,0,0,0,1,
        1,1,1,1,1,0,0,1,0,1,0,1,1,1,0,1,
        1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,1,
        1,0,1,1,0,1,1,1,0,1,1,1,0,1,0,1,
        1,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,
        1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,1,
        1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
      ]
    ];

    const questions = [
      {text:'Ù…Ø§ Ø¹Ø¯Ø¯ Ø®Ø·ÙˆØ§Øª Ø¥ØªØ®Ø§Ø° Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„ØªØ±Ø¨ÙˆÙŠØŸ', options:['ØªØ³Ø¹ Ø®Ø·ÙˆØ§Øª','Ø«Ù„Ø§Ø« Ø®Ø·ÙˆØ§Øª','Ø®Ù…Ø³ Ø®Ø·ÙˆØ§Øª'], correct:0, hint:'Ø¥ØªØ®Ø§Ø° Ù‚Ø±Ø§Ø± ØªØ±Ø¨ÙˆÙŠ Ù„ÙŠØ³Øª Ø¨Ø¹Ù…Ù„ÙŠØ© Ø³Ù‡Ù„Ø©'},
      {text:'Ù…Ø§ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£Ø®ÙŠØ±Ø© ÙÙŠ Ø¥ØªØ®Ø§Ø° Ù‚Ø±Ø§Ø± ØªØ±Ø¨ÙˆÙŠØŸ', options:['Ø¬Ù…Ø¹ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª','Ø§Ù„ØªÙ‚ÙŠÙŠÙ…','ØªÙ†ÙÙŠØ° Ø§Ù„Ù‚Ø±Ø§Ø±'], correct:1, hint:'Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„Ù…Ù‡Ù…Ø© Ù„Ø§ ÙŠØ¹Ù†ÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¹Ù…Ù„'},
      {text:'Ù…Ø§ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„ØªÙŠ ØªØ³Ø¨Ù‚ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù ÙÙŠ Ø¥ØªØ®Ø§Ø° Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„ØªØ±Ø¨ÙˆÙŠØŸ', options:['Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªÙ†ÙÙŠØ°','Ø¬Ù…Ø¹ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª','Ø¥Ù‚ØªØ±Ø§Ø­ Ø¨Ø¯Ø§Ø¦Ù„'], correct:1, hint:'Ù‚Ø¨Ù„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‡Ø¯ÙØŒ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø®Øµ Ù…Ø¹Ø±ÙØ© Ù…Ø§ ÙŠØ±ÙŠØ¯'}
    ];

    // DOM refs
    const gridEl = document.getElementById('grid');
    const heartsEl = document.getElementById('hearts');
    const stageNumEl = document.getElementById('stageNum');
    const statStage = document.getElementById('statStage');
    const statHearts = document.getElementById('statHearts');
    const attemptsEl = document.getElementById('attempts');
    const statusEl = document.getElementById('status');

    const qOverlay = document.getElementById('questionOverlay');
    const qTitle = document.getElementById('qTitle');
    const qText = document.getElementById('qText');
    const qOptions = document.getElementById('qOptions');
    const closeQ = document.getElementById('closeQ');
    const gameOverOverlay = document.getElementById('gameOverOverlay');
    const gameOverMsg = document.getElementById('gameOverMsg');
    const tryAgain = document.getElementById('tryAgain');
    // Mobile controls
    const controlsMobile = document.getElementById("controlsMobile");
    const ctrlUp    = document.getElementById("ctrlUp");
    const ctrlDown  = document.getElementById("ctrlDown");
    const ctrlLeft  = document.getElementById("ctrlLeft");
    const ctrlRight = document.getElementById("ctrlRight");

    let map = []; // current map array
    let playerPos = {x:0,y:0};

    // Show mobile controls on mobile devices always (force show)
    function showMobileControls(){
      controlsMobile.style.display="flex";
    }

    window.addEventListener("resize", showMobileControls);

    function init(){
      renderHearts();
      loadStage(stage);
      setupControls();
      showMobileControls();
      document.getElementById('restart').addEventListener('click', ()=>resetGame());
      document.getElementById('hint').addEventListener('click', ()=>showHint());
      closeQ.addEventListener('click', ()=>{ hideQuestion(false); });
      tryAgain.addEventListener('click', ()=>{ gameOverOverlay.style.display='none'; resetGame(); });

      // Mobile controls
      ctrlUp.addEventListener("touchstart", e=>{e.preventDefault();movePlayerDirection("up");});
      ctrlDown.addEventListener("touchstart", e=>{e.preventDefault();movePlayerDirection("down");});
      ctrlLeft.addEventListener("touchstart", e=>{e.preventDefault();movePlayerDirection("left");});
      ctrlRight.addEventListener("touchstart", e=>{e.preventDefault();movePlayerDirection("right");});

      ctrlUp.addEventListener("click", ()=>movePlayerDirection("up"));
      ctrlDown.addEventListener("click", ()=>movePlayerDirection("down"));
      ctrlLeft.addEventListener("click", ()=>movePlayerDirection("left"));
      ctrlRight.addEventListener("click", ()=>movePlayerDirection("right"));

      gridEl.addEventListener('touchstart', ()=>gridEl.focus());
      gridEl.addEventListener('click', ()=>gridEl.focus());
    }

    function renderHearts(){
      heartsEl.innerHTML = '';
      for(let i=0;i<4;i++){
        const div = document.createElement('div'); div.className='heart' + (i >= hearts ? ' lost' : ''); heartsEl.appendChild(div);
      }
      statHearts.textContent = hearts;
    }

    function loadStage(n){
      stage = n;
      stageNumEl.textContent = stage;
      statStage.textContent = stage;
      statusEl.textContent = `Ø§Ù„Ù…Ø±Ø­Ù„Ø© ${stage} â€” ØªØ­Ø±Ùƒ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø®Ø±Ø¬`;
      map = maps[stage-1].slice();
      buildGrid();
    }

    function buildGrid(){
      gridEl.innerHTML = '';
      gridEl.style.gridTemplateColumns = `repeat(${gridCols}, 1fr)`;
      for(let r=0;r<gridRows;r++){
        for(let c=0;c<gridCols;c++){
          const idx = r*gridCols + c;
          const val = map[idx];
          const cell = document.createElement('div'); cell.className='cell';
          if(val===1) cell.classList.add('wall');
          if(val===3) cell.classList.add('exit');
          cell.dataset.r = r; cell.dataset.c = c; cell.id = `cell-${r}-${c}`;
          gridEl.appendChild(cell);
          if(val===2){ playerPos = {x:c,y:r}; placePlayer(); }
        }
      }
    }

    function placePlayer(){
      document.querySelectorAll('.player').forEach(p=>p.classList.remove('player'));
      const el = document.getElementById(`cell-${playerPos.y}-${playerPos.x}`);
      if(el) el.classList.add('player');
    }

    function setupControls(){
      window.addEventListener('keydown', (e)=>{
        const keys = ['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','w','a','s','d','W','A','S','D'];
        if(!keys.includes(e.key)) return;
        e.preventDefault();
        let dx=0, dy=0;
        if(document.documentElement.dir === "rtl") {
          if(e.key==='ArrowUp' || e.key==='w' || e.key==='W') dy=-1;
          if(e.key==='ArrowDown' || e.key==='s' || e.key==='S') dy=1;
          if(e.key==='ArrowLeft' || e.key==='d' || e.key==='D') dx=1;
          if(e.key==='ArrowRight' || e.key==='a' || e.key==='A') dx=-1;
        } else {
          if(e.key==='ArrowUp' || e.key==='w' || e.key==='W') dy=-1;
          if(e.key==='ArrowDown' || e.key==='s' || e.key==='S') dy=1;
          if(e.key==='ArrowLeft' || e.key==='a' || e.key==='A') dx=-1;
          if(e.key==='ArrowRight' || e.key==='d' || e.key==='D') dx=1;
        }
        movePlayer(dx,dy);
      });
    }

    function movePlayerDirection(dir){
      let dx=0,dy=0;
      if(document.documentElement.dir=="rtl"){
        if(dir==="up")dy=-1;
        if(dir==="down")dy=1;
        if(dir==="right")dx=1;
        if(dir==="left")dx=-1;
      }else{
        if(dir==="up")dy=-1;
        if(dir==="down")dy=1;
        if(dir==="right")dx=1;
        if(dir==="left")dx=-1;
      }
      movePlayer(dx,dy);
    }

    function movePlayer(dx,dy){
      const nx = playerPos.x + dx; const ny = playerPos.y + dy;
      if(nx<0||nx>=gridCols||ny<0||ny>=gridRows) return;
      const val = map[ny*gridCols + nx];
      if(val===1) return;
      playerPos = {x:nx,y:ny};
      placePlayer();
      if(val===3){
        attempts++;
        attemptsEl.textContent = attempts;
        showQuestionForStage(stage);
      }
    }

    function showQuestionForStage(s){
      const q = questions[s-1];
      qTitle.textContent = `Ø³Ø¤Ø§Ù„ Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø±Ø­Ù„Ø© ${s}`;
      qText.textContent = q.text;
      qOptions.innerHTML = '';
      q.options.forEach((opt, idx)=>{
        const btn = document.createElement('button'); btn.className='q-btn'; btn.textContent = (idx+1)+'. '+opt;
        btn.addEventListener('click', ()=>handleAnswer(idx,q));
        qOptions.appendChild(btn);
      });
      qOverlay.style.display='flex'; qOverlay.setAttribute('aria-hidden','false');
    }

    function hideQuestion(tookAction=true){
      qOverlay.style.display='none'; qOverlay.setAttribute('aria-hidden','true');
      if(!tookAction) statusEl.textContent = 'Ø£Ø¬Ø¨ Ø¹Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.';
    }

    function handleAnswer(idx,q){
      qOptions.querySelectorAll('button').forEach((b,i)=>{ b.classList.toggle('correct', i===q.correct); });
      setTimeout(()=>{
        if(idx===q.correct){
          statusEl.textContent = 'Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© â€” Ø§Ù„ØªÙ‚Ø¯Ù… Ù„Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©.';
          if(stage < totalStages){
            stage++;
            renderHearts();
            loadStage(stage);
            hideQuestion(true);
          } else {
            statusEl.textContent = 'Ù…Ø¨Ø±ÙˆÙƒ! Ø£Ù†Ù‡ÙŠØª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ø­Ù„.';
            hideQuestion(true);
            showVictory();
          }
        } else {
          hearts = Math.max(0, hearts-1);
          renderHearts();
          statusEl.textContent = 'Ø®Ø§Ø·Ø¦ â€” ØªÙ… Ø®ØµÙ… Ù‚Ù„Ø¨ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø±Ø­Ù„Ø©.';
          hideQuestion(true);
          if(hearts<=0){
            showGameOver();
            return;
          }
          if(stage>1) stage--;
          loadStage(stage);
        }
      }, 700);
    }

    function showVictory(){
      qTitle.textContent = 'ğŸ‰ ØªÙ‡Ø§Ù†ÙŠÙ†Ø§!';
      qText.textContent = 'Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ ÙˆÙØ²Øª Ø¨Ø§Ù„Ù„Ø¹Ø¨Ø©.';
      qOptions.innerHTML = '';
      const btn = document.createElement('button'); btn.className='q-btn'; btn.textContent='Ø§Ù„Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
      btn.addEventListener('click', ()=>{ hideQuestion(true); resetGame(); });
      qOptions.appendChild(btn);
      qOverlay.style.display='flex'; qOverlay.setAttribute('aria-hidden','false');
    }

    function showGameOver(){
      gameOverMsg.textContent = 'ÙÙÙ‚Ø¯Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ù„ÙˆØ¨ â€” Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù†ØªÙ‡Øª.';
      gameOverOverlay.style.display='flex'; gameOverOverlay.setAttribute('aria-hidden','false');
    }

    function resetGame(){
      hearts = 4; attempts = 0; statHearts.textContent = hearts; attemptsEl.textContent = attempts; renderHearts(); stage=1; loadStage(stage); statusEl.textContent='Ø§Ù„Ù„Ø¹Ø¨Ø© Ø£Ø¹ÙŠØ¯Øª'; gameOverOverlay.style.display='none'; qOverlay.style.display='none';
    }

    function showHint(){
      const q = questions[stage-1];
      alert('ØªÙ„Ù…ÙŠØ­: '+q.hint);
    }

    init();
  </script>
</body>
</html>
